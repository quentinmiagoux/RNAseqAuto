---
title: "RNA-seq QC - All individuals"
author: "Quentin Miagoux"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    theme: united
    highlight: tango
    keep_md: yes
    number_sections: yes
    toc: yes
    toc_float: yes
    css: "../my_css.css"
params:
  expr_xlsx: ""
  coldata_xlsx: ""
  top_variable_genes: 500
  samples_to_exclude:
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.height = 8,
  fig.width = 10
)
```

```{r packages}
library("openxlsx")
library("tidyverse")
library("DESeq2")
library("matrixStats")
library("pheatmap")
library("viridis")
```


```{r load-data}
expr <- openxlsx::read.xlsx("data/gene_expression.xlsx")

counts <- expr %>%
  dplyr::select(gene_symbol, starts_with("read_count_")) %>%
  mutate(across(-gene_symbol, as.numeric)) %>%
  mutate(across(-gene_symbol, round))

rownames(counts) <- counts$gene_symbol
counts <- counts[, -1, drop = FALSE]
counts_mat <- round(as.matrix(counts))
storage.mode(counts_mat) <- "integer"

colnames(counts_mat) <- colnames(counts_mat) %>%
  str_remove("^read_count_") %>%
  str_replace("^DNM2_", "DNMII")

counts_mat <- counts_mat[, str_detect(colnames(counts_mat), "^(DMD|WT|DN|LMNA|GSDII|DNMII)")]

ord <- order(as.integer(sub("^.*_", "", colnames(counts_mat))))
counts_mat <- counts_mat[, ord]

colnames(counts_mat) <- colnames(counts_mat) %>%
  sub("[0-9]+_", "_", .) %>%
  str_remove("_")
colnames(counts_mat) <- paste0(colnames(counts_mat), "_", rep(c(1, 2, 3)))


coldata <- tibble(samples = colnames(counts_mat)) %>%
  mutate(
    condition = sub("[0-9].*$", "", samples),
    condition_key = str_split(samples, "_", simplify = TRUE)[, 1]
  )

if (file.exists(params$coldata_xlsx)) {
  info <- openxlsx::read.xlsx(params$coldata_xlsx)
  if ("Dreams" %in% colnames(info)) {
    coldata <- coldata %>%
      left_join(info, by = c("condition_key" = "Dreams"))
  }
}

coldata_df <- as.data.frame(coldata)
rownames(coldata_df) <- coldata_df$samples
```


```{r rld}
dds <- DESeqDataSetFromMatrix(
  countData = counts_mat,
  colData = coldata_df,
  design = ~1
)

dds <- dds[rowSums(counts(dds)) > 10, ]
rld <- rlog(dds, blind = TRUE)
```

# QC {.tabset .tabset-fade}

```{r pca-setup}
ntop_all_genes <- nrow(assay(rld))

pca_all <- plotPCA(
  rld,
  intgroup = c("samples", "condition"),
  returnData = TRUE,
  ntop = ntop_all_genes
)
percent_var_all <- round(100 * attr(pca_all, "percentVar"))

pca_all <- pca_all %>%
  mutate(samples = str_split(samples, "_", simplify = TRUE)[, 1])

pca_top <- plotPCA(
  rld,
  intgroup = c("samples", "condition"),
  returnData = TRUE,
  ntop = 500
)
percent_var_top <- round(100 * attr(pca_top, "percentVar"))

pca_top <- pca_top %>%
  mutate(samples = str_split(samples, "_", simplify = TRUE)[, 1])

ann <- coldata_df %>%
  select(any_of(c("condition", "condition_key")))

rb_palette <- colorRampPalette(c("#2166AC", "white", "#B2182B"))(100)

samples_to_exclude <- params$samples_to_exclude
if (is.null(samples_to_exclude)) {
  samples_to_exclude <- character(0)
}

keep_samples <- if (length(samples_to_exclude) > 0) {
  !(coldata_df$condition_key %in% samples_to_exclude)
} else {
  rep(TRUE, nrow(coldata_df))
}
rld_filtered <- rld[, keep_samples]
ann_filtered <- ann[keep_samples, , drop = FALSE]

pca_all_filtered <- plotPCA(
  rld_filtered,
  intgroup = c("samples", "condition"),
  returnData = TRUE,
  ntop = nrow(assay(rld_filtered))
)
percent_var_all_filtered <- round(100 * attr(pca_all_filtered, "percentVar"))

pca_all_filtered <- pca_all_filtered %>%
  mutate(samples = str_split(samples, "_", simplify = TRUE)[, 1])

pca_top_filtered <- plotPCA(
  rld_filtered,
  intgroup = c("samples", "condition"),
  returnData = TRUE,
  ntop = 500
)
percent_var_top_filtered <- round(100 * attr(pca_top_filtered, "percentVar"))

pca_top_filtered <- pca_top_filtered %>%
  mutate(samples = str_split(samples, "_", simplify = TRUE)[, 1])
```

```{r excluded-label, echo=FALSE}
excluded_label <- if (length(samples_to_exclude) > 0) {
  paste(samples_to_exclude, collapse = " and ")
} else {
  "no excluded samples"
}
filtered_section_label <- if (length(samples_to_exclude) > 0) {
  paste("Without", excluded_label)
} else {
  "All samples (no exclusions)"
}
```

## Gold standard QC metrics {.tabset .tabset-fade}

### Basic sample metrics (counts)

```{r qc-sample-metrics}
# From raw counts
lib_size <- colSums(counts_mat)
detected <- colSums(counts_mat > 0)
zero_frac <- colMeans(counts_mat == 0)

qc_df <- tibble(
  sample = colnames(counts_mat),
  lib_size = lib_size,
  detected_genes = detected,
  zero_fraction = zero_frac
) %>%
  left_join(
    coldata %>% select(samples, condition, condition_key),
    by = c("sample" = "samples")
  )

# Library size
ggplot(qc_df, aes(x = reorder(sample, lib_size), y = lib_size, fill = condition_key)) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  labs(title = "Library size (sum of counts)", x = NULL, y = "Total counts")

# Detected genes
ggplot(qc_df, aes(x = reorder(sample, detected_genes), y = detected_genes, fill = condition_key)) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  labs(title = "Detected genes (# genes with >0 counts)", x = NULL, y = "Detected genes")

# Zero fraction
ggplot(qc_df, aes(x = reorder(sample, zero_fraction), y = zero_fraction, fill = condition_key)) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  labs(title = "Zero fraction (sparsity)", x = NULL, y = "Fraction zeros")
```

### RLD distributions

```{r qc-rld-distribution}
mat <- assay(rld)
df_long <- as_tibble(mat, rownames = "gene") %>%
  pivot_longer(-gene, names_to = "sample", values_to = "rld") %>%
  left_join(coldata %>% select(samples, condition_key), by = c("sample" = "samples"))

# Boxplot per sample
ggplot(df_long, aes(x = sample, y = rld, fill = condition_key)) +
  geom_boxplot(outlier.size = 0.2) +
  coord_flip() +
  theme_bw() +
  labs(title = "RLD expression distribution per sample", x = NULL, y = "RLD")

# Density overlay (downsample to keep it light)
set.seed(1)
df_small <- df_long %>% sample_n(min(n(), 200000))
ggplot(df_small, aes(x = rld, group = sample, color = condition_key)) +
  geom_density(alpha = 0.3) +
  theme_bw() +
  labs(title = "RLD density (downsampled)", x = "RLD", y = "Density")
```

### Mitochondrial fraction (if MT- / mt- genes present)

```{r qc-mito-fraction}
gene <- rownames(counts_mat)
mito_idx <- grepl("^MT-", gene) | grepl("^mt-", gene)

if (any(mito_idx)) {
  mito_counts <- colSums(counts_mat[mito_idx, , drop = FALSE])
  total_counts <- colSums(counts_mat)
  mito_frac <- mito_counts / pmax(total_counts, 1)

  mito_df <- tibble(
    sample = colnames(counts_mat),
    mito_fraction = mito_frac
  ) %>%
    left_join(coldata %>% select(samples, condition_key), by = c("sample" = "samples"))

  ggplot(mito_df, aes(x = reorder(sample, mito_fraction), y = mito_fraction, fill = condition_key)) +
    geom_col() +
    coord_flip() +
    theme_bw() +
    labs(title = "Mitochondrial fraction (if MT- genes present)", x = NULL, y = "Fraction of counts")
} else {
  cat("No mitochondrial genes detected by prefix ^MT- or ^mt- in gene symbols.\n")
}
```

### DESeq2 outlier diagnostic (Cook's distance)

```{r deseq2-diagnostics}
dds_qc <- dds
dds_qc <- estimateSizeFactors(dds_qc)
dds_qc <- estimateDispersions(dds_qc)

# Cook's distances are computed during DESeq() (fits GLMs)
dds_qc <- DESeq(dds_qc, test = "Wald", fitType = "parametric", quiet = TRUE)

cd <- assays(dds_qc)[["cooks"]]
max_cooks <- apply(cd, 2, max, na.rm = TRUE)

cooks_df <- tibble(
  sample = colnames(dds_qc),
  max_cooks = max_cooks
) %>%
  left_join(coldata %>% select(samples, condition_key), by = c("sample" = "samples"))

ggplot(cooks_df, aes(x = reorder(sample, max_cooks), y = max_cooks, fill = condition_key)) +
  geom_col() +
  coord_flip() +
  theme_bw() +
  labs(title = "Max Cook's distance per sample (DESeq2 diagnostic)", x = NULL, y = "Max Cook's distance")
```

## All individuals {.tabset .tabset-fade}

### All genes

#### PCA

```{r pca-all-genes}
ggplot(pca_all, aes(PC1, PC2, color = samples)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_shape_manual(values = 16:22) +
  scale_color_viridis_d(option = "turbo") +
  labs(
    title = "PCA (all genes)",
    x = paste0("PC1: ", percent_var_all[1], "% variance"),
    y = paste0("PC2: ", percent_var_all[2], "% variance")
  ) +
  coord_fixed(ratio = 4 / 3) +
  theme_bw()
```

#### Sample correlation heatmap 

```{r heatmap-sample-correlation}
mat <- assay(rld)
cors <- cor(mat, method = "pearson")

pheatmap(
  cors,
  fontsize_col = 9,
  fontsize_row = 9,
  color = rb_palette,
  main = "Sample-to-sample correlation (Pearson, RLD)"
)
```

#### Sample distance heatmap 

```{r heatmap-sample-distance}
mat <- assay(rld)
d <- dist(t(mat))
dmat <- as.matrix(d)

pheatmap(
  dmat,
  fontsize_col = 9,
  fontsize_row = 9,
  color = rb_palette,
  main = "Sample distance heatmap (Euclidean on RLD)"
)
```

### Top 500 variable genes

#### PCA

```{r pca-top-genes}
ggplot(pca_top, aes(PC1, PC2, color = samples)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_shape_manual(values = 16:22) +
  scale_color_viridis_d(option = "turbo") +
  labs(
    title = "PCA (top 500 variable genes)",
    x = paste0("PC1: ", percent_var_top[1], "% variance"),
    y = paste0("PC2: ", percent_var_top[2], "% variance")
  ) +
  theme_bw()
```

#### Heatmap

```{r heatmap-top-genes}
top_n <- params$top_variable_genes
vars <- matrixStats::rowVars(assay(rld))
top_genes <- order(vars, decreasing = TRUE)[seq_len(min(top_n, length(vars)))]
rld_top <- rld[top_genes, ]

mat_top <- assay(rld_top)

pheatmap(
  mat_top,
  annotation_col = ann,
  show_rownames = FALSE,
  fontsize_col = 9,
  scale = "row",
  clustering_distance_rows = "correlation",
  clustering_distance_cols = "correlation",
  color = rb_palette,
  main = paste0("Heatmap (top ", top_n, " variable genes)")
)
```

## `r filtered_section_label` {.tabset .tabset-fade}

### All genes

#### PCA

```{r pca-all-genes-no-wt3-dmd9}
ggplot(pca_all_filtered, aes(PC1, PC2, color = samples)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_shape_manual(values = 16:22) +
  scale_color_viridis_d(option = "turbo") +
  labs(
    title = paste("PCA (all genes,", filtered_section_label, ")"),
    x = paste0("PC1: ", percent_var_all_filtered[1], "% variance"),
    y = paste0("PC2: ", percent_var_all_filtered[2], "% variance")
  ) +
  theme_bw()
```

#### Sample correlation heatmap (filtered)

```{r heatmap-sample-correlation-filtered}
mat <- assay(rld_filtered)
cors <- cor(mat, method = "pearson")

pheatmap(
  cors,
  fontsize_col = 9,
  fontsize_row = 9,
  color = rb_palette,
  main = "Sample-to-sample correlation (filtered)"
)
```

#### Sample distance heatmap (filtered)

```{r heatmap-sample-distance-filtered}
mat <- assay(rld_filtered)
d <- dist(t(mat))
dmat <- as.matrix(d)

pheatmap(
  dmat,
  fontsize_col = 9,
  fontsize_row = 9,
  color = rb_palette,
  main = "Sample distance heatmap (filtered)"
)
```

### Top 500 variable genes

#### PCA

```{r pca-top-genes-no-wt3-dmd9}
ggplot(pca_top_filtered, aes(PC1, PC2, color = samples)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_shape_manual(values = 16:22) +
  scale_color_viridis_d(option = "turbo") +
  labs(
    title = paste("PCA (top 500 variable genes,", filtered_section_label, ")"),
    x = paste0("PC1: ", percent_var_top_filtered[1], "% variance"),
    y = paste0("PC2: ", percent_var_top_filtered[2], "% variance")
  ) +
  theme_bw()
```

#### Heatmap

```{r heatmap-top-genes-no-wt3-dmd9}
top_n <- params$top_variable_genes
vars <- matrixStats::rowVars(assay(rld_filtered))
top_genes <- order(vars, decreasing = TRUE)[seq_len(min(top_n, length(vars)))]
rld_top <- rld_filtered[top_genes, ]

mat_top <- assay(rld_top)

pheatmap(
  mat_top,
  annotation_col = ann_filtered,
  show_rownames = FALSE,
  fontsize_col = 9,
  scale = "row",
  clustering_distance_rows = "correlation",
  clustering_distance_cols = "correlation",
  color = rb_palette,
  main = paste0("Heatmap (top ", top_n, " variable genes, ", filtered_section_label, ")")
)
```
