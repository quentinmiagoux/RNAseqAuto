---
title: "DEP"
author: "Quentin"
date: "`r Sys.Date()`"
output: html_document
params:
  msstats_quant: "data/msstats_quant_result.xls"
  output_root: "results"
  run_tag: ""
  lfc: 2
  padj: 0.05
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

```{r packages}
library(tidyverse)
library(openxlsx)
library(DT)
library(crosstalk)
library(ComplexHeatmap)
library(eulerr)
library(RColorBrewer)
library(reactable)
library(limma)
library(ComplexUpset)

stopifnot(file.exists(params$msstats_quant))
df <- read.table(file = params$msstats_quant, header = TRUE)
```

# Parameters used

```{r analysis-parameters}
analysis_params <- tibble::tibble(
  parameter = c("run_tag", "fold_change (lfc)", "padj", "msstats_quant", "output_root"),
  value = c(
    params$run_tag,
    as.character(params$lfc),
    as.character(params$padj),
    params$msstats_quant,
    params$output_root
  )
)

DT::datatable(
  analysis_params,
  rownames = FALSE,
  options = list(dom = "t", paging = FALSE),
  class = "compact stripe"
)
```


# DEP

```{r dep-main}
fc_cutoff_log2 <- log2(params$lfc)
padj_cutoff <- params$padj

df2 <- df %>%
  dplyr::filter(!Condition %in% c("DMD_C11", "DMD_9", "DNM2_C57", "EDMD2_C35", "WT_Cas9", "WT3")) %>%
  group_by(PG.Genes, originalRUN, Condition) %>%
  summarise(Intensity = median(Intensity, na.rm = TRUE), .groups = "drop")

mat <- df2 %>%
  select(PG.Genes, originalRUN, Intensity) %>%
  pivot_wider(names_from = originalRUN, values_from = Intensity) %>%
  column_to_rownames("PG.Genes") %>%
  as.matrix()

mat_log <- log2(mat)

meta <- df2 %>%
  select(originalRUN, Condition) %>%
  distinct()

meta$disease <- case_when(
  grepl("^WT", meta$Condition) ~ "WT",
  grepl("^DMD", meta$Condition) ~ "DMD",
  grepl("^DNM2", meta$Condition) ~ "DNM2",
  grepl("^LMNA", meta$Condition) ~ "LMNA",
  grepl("^GSDII", meta$Condition) ~ "GSDII",
  grepl("^DN_", meta$Condition) ~ "DN",
  TRUE ~ "Other"
)

meta <- meta[match(colnames(mat_log), meta$originalRUN), ]

meta$group <- ifelse(meta$disease == "WT", "WT", "Disease")
meta$group <- factor(meta$group, levels = c("WT", "Disease"))

design <- model.matrix(~0 + group, meta)
colnames(design) <- c("WT", "Disease")

fit <- lmFit(mat_log, design)
contrast <- makeContrasts(Disease - WT, levels = design)
fit2 <- eBayes(contrasts.fit(fit, contrast))
res_all <- topTable(fit2, number = Inf)

meta$disease <- factor(meta$disease)
design2 <- model.matrix(~0 + disease, meta)
colnames(design2) <- levels(meta$disease)

fit <- lmFit(mat_log, design2)
contrasts <- makeContrasts(
  DMD - WT,
  DNM2 - WT,
  LMNA - WT,
  GSDII - WT,
  DN - WT,
  levels = design2
)

fit2 <- eBayes(contrasts.fit(fit, contrasts))

res_each <- lapply(colnames(contrasts), function(cn) {
  topTable(fit2, coef = cn, number = Inf) %>%
    rownames_to_column("protein") %>%
    mutate(contrast = cn)
}) %>% bind_rows()

sig_all <- res_all %>%
  rownames_to_column(var = "protein") %>%
  filter(adj.P.Val < padj_cutoff, abs(logFC) > fc_cutoff_log2)

sig_each <- res_each %>%
  filter(adj.P.Val < padj_cutoff, abs(logFC) > fc_cutoff_log2)

sig_DMD <- sig_each %>% dplyr::filter(contrast == "DMD - WT")
sig_DN <- sig_each %>% dplyr::filter(contrast == "DN - WT")
sig_GSDII <- sig_each %>% dplyr::filter(contrast == "GSDII - WT")
sig_LMNA <- sig_each %>% dplyr::filter(contrast == "LMNA - WT")
sig_DNM2 <- sig_each %>% dplyr::filter(contrast == "DNM2 - WT")

all_comp <- list(
  DMD = sig_DMD,
  DN = sig_DN,
  GSDII = sig_GSDII,
  DNM2 = sig_DNM2,
  LMNA = sig_LMNA,
  ALL = sig_all
)

genes_direction <- function(x) {
  purrr::map(x, function(df_item) {
    dplyr::mutate(
      df_item,
      genes_directed = dplyr::if_else(
        logFC > 0,
        paste0(protein, "_up"),
        paste0(protein, "_down")
      )
    )
  })
}

tmp <- genes_direction(all_comp) %>% purrr::map(function(df_item) pull(df_item, genes_directed))
```

```{r upset-plot}
df_up <- UpSetR::fromList(tmp[1:6])

ComplexUpset::upset(
  df_up,
  intersect = names(tmp[1:6]),
  name = "Genes",
  min_degree = 2,
  width_ratio = 0.2,
  stripes = c("#E78AC3", "#A6D854", "#FFD92F", "#8DA0CB", "#FC8D62", "#66C2A5")
)
```

```{r venn, echo=FALSE}
sets <- tmp[1:5]
stopifnot(is.list(sets), length(sets) == 5)
stopifnot(!is.null(names(sets)))

names(sets) <- trimws(names(sets))
sets <- sets[!is.na(names(sets)) & names(sets) != ""]

cm <- make_comb_mat(sets)
cols <- setNames(brewer.pal(length(sets), "Set2"), names(sets))
fit <- venn(sets)

plot(
  fit,
  fills = list(fill = cols, alpha = 0.35),
  labels = list(font = 2, cex = 1.0),
  quantities = list(type = "counts", font = 2, cex = 0.9),
  legend = FALSE
)
```

```{r matching}
.map_diseases <- function(diseases, sets) {
  dn <- trimws(diseases)
  lookup <- setNames(names(sets), tolower(names(sets)))
  hit <- lookup[tolower(dn)]
  if (any(is.na(hit))) {
    stop(
      "Unknown disease name(s): ",
      paste(dn[is.na(hit)], collapse = ", "),
      "\nAvailable: ",
      paste(names(sets), collapse = ", ")
    )
  }
  unname(hit)
}

get_genes <- function(diseases, sets) {
  diseases <- .map_diseases(diseases, sets)
  Reduce(intersect, sets[diseases])
}

get_genes_exclusive <- function(diseases, sets) {
  diseases <- .map_diseases(diseases, sets)
  others <- setdiff(names(sets), diseases)
  x <- Reduce(intersect, sets[diseases])
  if (length(others)) {
    x <- setdiff(x, Reduce(union, sets[others]))
  }
  x
}

genes_DMD_LMNA_incl <- get_genes(c("DMD", "LMNA", "GSDII", "DN", "DNM2"), sets)
genes_DMD_LMNA_only <- get_genes_exclusive(c("DMD", "LMNA", "GSDII", "DN", "DNM2"), sets)

comb_m <- as.matrix(cm)
comb_names <- comb_name(cm)
combo_label <- function(x) paste(x, collapse = " & ")

exclusive_df <- do.call(rbind, lapply(seq_along(comb_names), function(i) {
  on_sets <- rownames(comb_m)[which(comb_m[, i] == 1)]
  g <- extract_comb(cm, comb_names[i])
  if (length(g) == 0) return(NULL)

  data.frame(
    intersection = combo_label(on_sets),
    gene = g,
    stringsAsFactors = FALSE
  )
}))

exclusive_df <- exclusive_df[grepl("&", exclusive_df$intersection, fixed = TRUE), , drop = FALSE]
exclusive_df <- exclusive_df[order(exclusive_df$intersection, exclusive_df$gene), ]

sd <- SharedData$new(exclusive_df)

filter_select(
  id = "intersection",
  label = "Choose a Venn intersection",
  sharedData = sd,
  group = ~intersection,
  multiple = FALSE
)

DT::datatable(
  sd,
  rownames = FALSE,
  options = list(
    pageLength = 50,
    dom = "ftip",
    columnDefs = list(
      list(visible = FALSE, targets = which(names(exclusive_df) == "intersection") - 1)
    )
  ),
  class = "compact stripe",
  filter = "none"
)
```

# Disease logFC summary table

```{r disease-summary-table-build}
target_diseases <- c("DMD", "DN", "GSDII", "LMNA", "DNM2")

disease_full_tables <- purrr::map(target_diseases, function(disease) {
  contrast_name <- paste0(disease, " - WT")
  res_each %>%
    filter(contrast == contrast_name) %>%
    transmute(
      protein,
      !!paste0("logFC_", disease) := round(logFC, 3),
      !!paste0("pass_", disease) := adj.P.Val < padj_cutoff & abs(logFC) > fc_cutoff_log2
    ) %>%
    distinct(protein, .keep_all = TRUE)
})

names(disease_full_tables) <- target_diseases

gene_disease_summary <- reduce(disease_full_tables, full_join, by = "protein") %>%
  mutate(across(starts_with("pass_"), ~replace_na(.x, FALSE))) %>%
  mutate(Count = rowSums(across(starts_with("pass_"), as.integer)))

for (d in target_diseases) {
  logfc_col <- paste0("logFC_", d)
  if (!logfc_col %in% names(gene_disease_summary)) {
    gene_disease_summary[[logfc_col]] <- NA_real_
  }
}

gene_disease_summary <- gene_disease_summary %>%
  select(protein, all_of(paste0("logFC_", target_diseases)), Count) %>%
  arrange(desc(Count), protein)
```

```{r disease-excel-export}
run_tag <- params$run_tag
if (is.null(run_tag) || !nzchar(run_tag)) {
  run_tag <- "DEP"
}

output_root <- params$output_root
dir.create(output_root, recursive = TRUE, showWarnings = FALSE)

for (disease in target_diseases) {
  disease_dir <- file.path(output_root, disease)
  dir.create(disease_dir, recursive = TRUE, showWarnings = FALSE)

  disease_sig <- sig_each %>%
    filter(contrast == paste0(disease, " - WT"))

  disease_output_file <- file.path(
    disease_dir,
    paste0("DEPs_", disease, "_", run_tag, ".xlsx")
  )

  openxlsx::write.xlsx(disease_sig, disease_output_file, overwrite = TRUE)
}

summary_xlsx <- file.path(output_root, paste0("DEP_gene_disease_logFC_summary_", run_tag, ".xlsx"))
openxlsx::write.xlsx(gene_disease_summary, summary_xlsx, overwrite = TRUE)
```

```{r disease-summary-table-display}
DT::datatable(
  gene_disease_summary,
  rownames = FALSE,
  options = list(
    pageLength = 25,
    scrollX = TRUE
  ),
  class = "compact stripe"
)
```
