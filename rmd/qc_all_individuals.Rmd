---
title: "RNA-seq QC - Tous les individus"
author: "Quentin Miagoux"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    theme: united
    highlight: tango
    keep_md: yes
    number_sections: yes
    toc: yes
    toc_float: yes
    css: "../my_css.css"
params:
  expr_xlsx: ""
  coldata_xlsx: ""
  top_variable_genes: 500
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.height = 8,
  fig.width = 10
)
```

```{r packages}
library("openxlsx")
library("tidyverse")
library("DESeq2")
library("matrixStats")
library("pheatmap")
library("viridis")
```

# Data loading

```{r load-data}
stopifnot(file.exists(params$expr_xlsx))
expr <- openxlsx::read.xlsx(params$expr_xlsx)

counts <- expr %>%
  dplyr::select(gene_symbol, starts_with("read_count_")) %>%
  mutate(across(-gene_symbol, as.numeric)) %>%
  mutate(across(-gene_symbol, round))

rownames(counts) <- counts$gene_symbol
counts <- counts[, -1, drop = FALSE]
counts_mat <- round(as.matrix(counts))
storage.mode(counts_mat) <- "integer"

colnames(counts_mat) <- colnames(counts_mat) %>%
  str_remove("^read_count_") %>%
  str_replace("^DNM2_", "DNMII")

counts_mat <- counts_mat[, str_detect(colnames(counts_mat), "^(DMD|WT|DN|LMNA|GSDII|DNMII)")]

ord <- order(as.integer(sub("^.*_", "", colnames(counts_mat))))
counts_mat <- counts_mat[, ord]

colnames(counts_mat) <- colnames(counts_mat) %>%
  sub("[0-9]+_", "_", .) %>%
  str_remove("_")
colnames(counts_mat) <- paste0(colnames(counts_mat), "_", rep(c(1, 2, 3)))

counts_mat <- counts_mat[, !str_detect(colnames(counts_mat), "DMD9|WT3")]

coldata <- tibble(samples = colnames(counts_mat)) %>%
  mutate(
    condition = sub("[0-9].*$", "", samples),
    condition_key = str_split(samples, "_", simplify = TRUE)[, 1]
  )

if (file.exists(params$coldata_xlsx)) {
  info <- openxlsx::read.xlsx(params$coldata_xlsx)
  if ("Dreams" %in% colnames(info)) {
    coldata <- coldata %>%
      left_join(info, by = c("condition_key" = "Dreams"))
  }
}

coldata_df <- as.data.frame(coldata)
rownames(coldata_df) <- coldata_df$samples
```

# VST transformation

```{r vst}
dds <- DESeqDataSetFromMatrix(
  countData = counts_mat,
  colData = coldata_df,
  design = ~1
)

dds <- dds[rowSums(counts(dds)) > 10, ]
vsd <- vst(dds, blind = TRUE)
```

# PCA - all genes

```{r pca-all-genes}
pca_all <- plotPCA(vsd, intgroup = c("samples", "condition"), returnData = TRUE)
percent_var <- round(100 * attr(pca_all, "percentVar"))

pca_all <- pca_all %>%
  mutate(samples = str_split(samples, "_", simplify = TRUE)[, 1])

ggplot(pca_all, aes(PC1, PC2, color = samples)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_shape_manual(values = 16:22) +
  scale_color_viridis_d(option = "turbo") +
  labs(
    title = "PCA (all genes)",
    x = paste0("PC1: ", percent_var[1], "% variance"),
    y = paste0("PC2: ", percent_var[2], "% variance")
  ) +
  coord_fixed(ratio = 4 / 3) +
  theme_bw()
```

# Heatmap - sample distances (all genes)

```{r heatmap-sample-distance}
sample_dist <- dist(t(assay(vsd)))
sample_dist_mat <- as.matrix(sample_dist)

ann <- coldata_df %>%
  select(any_of(c("condition", "condition_key")))

rb_palette <- colorRampPalette(c("#2166AC", "white", "#B2182B"))(100)

pheatmap(
  sample_dist_mat,
  annotation_col = ann,
  annotation_row = ann,
  fontsize_col = 9,
  fontsize_row = 9,
  color = rb_palette,
  main = "Sample distances (all genes)"
)
```

# Select most variable genes

```{r select-top-genes}
top_n <- params$top_variable_genes
vars <- matrixStats::rowVars(assay(vsd))
top_genes <- order(vars, decreasing = TRUE)[seq_len(min(top_n, length(vars)))]
vsd_top <- vsd[top_genes, ]
```

# PCA - top variable genes

```{r pca-top-genes}
vsd_top_mat <- t(assay(vsd_top))
pca_top <- prcomp(vsd_top_mat, scale. = FALSE)
pca_top_df <- as_tibble(pca_top$x[, 1:2], rownames = "samples") %>%
  left_join(coldata, by = "samples") %>%
  mutate(samples = str_split(samples, "_", simplify = TRUE)[, 1])

percent_var_top <- round(100 * (pca_top$sdev^2 / sum(pca_top$sdev^2)))[1:2]

ggplot(pca_top_df, aes(PC1, PC2, color = samples)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_shape_manual(values = 16:22) +
  scale_color_viridis_d(option = "turbo") +
  labs(
    title = paste0("PCA (top ", top_n, " variable genes)"),
    x = paste0("PC1: ", percent_var_top[1], "% variance"),
    y = paste0("PC2: ", percent_var_top[2], "% variance")
  ) +
  coord_fixed(ratio = 4 / 3) +
  theme_bw()
```

# Heatmap - top variable genes

```{r heatmap-top-genes}
mat_top <- assay(vsd_top)
mat_top <- mat_top - rowMeans(mat_top)

pheatmap(
  mat_top,
  annotation_col = ann,
  show_rownames = FALSE,
  fontsize_col = 9,
  scale = "row",
  clustering_distance_rows = "correlation",
  clustering_distance_cols = "correlation",
  color = rb_palette,
  main = paste0("Heatmap (top ", top_n, " variable genes)")
)
```
