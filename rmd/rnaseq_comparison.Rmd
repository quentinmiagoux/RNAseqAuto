---
title: "DREAMS RNAseq"
author: "Quentin Miagoux"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    theme: united
    highlight: tango
    keep_md: yes
    number_sections: yes
    smart: no
    toc: yes
    toc_float: yes
    css: "../my_css.css"
    code_folding: hide
params:
  comparison: ""
  group_a: ""
  group_b: ""
  expr_xlsx: ""
  coldata_xlsx: ""
  merge_replicates:
  lfc_threshold:
  design_formula: ""
  samples_to_exclude:
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.height = 10,
  fig.width = 8
)
```

```{r packages}
library("openxlsx")
library("DT")
library("clusterProfiler")
library("ComplexHeatmap")
library("ReactomePA")
library("org.Hs.eg.db")
library("DOSE")
library("AnnotationHub")
library("downloadthis")
library("enrichplot")
library("tidyverse")
library("biomaRt")
library("EnhancedVolcano")
library("scales")
library("DESeq2")
set.seed(123)
```

```{r functions}
datatable_fun <- function(x) {
  x %>%
    mutate_if(is.numeric, ~format(., scientific = TRUE, digits = 2)) %>%
    datatable(
      options = list(pageLength = 10, scrollX = "400px"),
      filter = "top",
      rownames = FALSE,
      escape = FALSE
    )
}

select_group <- function(group, condition) {
  case_when(
    group == "Dystrophy" ~ condition %in% c("DMD", "LMNA", "DNMII"),
    group == "glycogenosis" ~ condition %in% c("DN", "GSDII"),
    group == "AllDiseases" ~ condition %in% c("DMD", "DN", "LMNA", "DNMII", "GSDII"),
    group == "DNM2" ~ condition == "DNMII",
    TRUE ~ condition == group
  )
}

canonicalize_group <- function(group) {
  normalized <- group %>%
    str_trim() %>%
    str_replace_all("[ _-]", "") %>%
    str_to_lower()

  case_when(
    normalized == "alldiseases" ~ "AllDiseases",
    normalized == "dystrophy" ~ "Dystrophy",
    normalized == "glycogenosis" ~ "glycogenosis",
    normalized == "dnm2" ~ "DNM2",
    normalized == "dnmii" ~ "DNM2",
    normalized == "dmd" ~ "DMD",
    normalized == "wt" ~ "WT",
    normalized == "dn" ~ "DN",
    normalized == "lmna" ~ "LMNA",
    normalized == "gsdii" ~ "GSDII",
    TRUE ~ group
  )
}
```

```{r transform-data}
cat("R getwd(): ", getwd(), "\n")
cat("expr_xlsx: ", params$expr_xlsx, "\n")
cat("exists: ", file.exists(params$expr_xlsx), "\n")
stopifnot(file.exists(params$expr_xlsx))
expr <- openxlsx::read.xlsx(params$expr_xlsx)
expr2 <- expr %>%
  dplyr::select(gene_symbol, starts_with("read_count_"))
expr2[, -1] <- expr2[, -1] %>% mutate_all(as.numeric) %>% mutate_all(round)
expr3 <- expr2 %>%
  dplyr::select(gene_symbol, starts_with("read_count_")) %>%
  as.data.frame()

rownames(expr3) <- expr2$gene_symbol
expr3 <- as.matrix(expr3[, -1])
storage.mode(expr3) <- "integer"

colnames(expr3) <- colnames(expr3) %>%
  str_remove("^read_count_") %>%
  str_replace("^DNM2_", "DNMII")

expr3 <- expr3[, str_detect(colnames(expr3), "^(DMD|WT|DN|LMNA|GSDII|DNMII)")]

ord <- order(as.integer(sub("^.*_", "", colnames(expr3))))
expr3 <- expr3[, ord]

colnames(expr3) <- colnames(expr3) %>%
  sub("[0-9]+_", "_", .) %>%
  str_remove("_")
colnames(expr3) <- paste0(colnames(expr3), "_", rep(c(1, 2, 3)))

group_a <- canonicalize_group(params$group_a)
group_b <- canonicalize_group(params$group_b)

info <- openxlsx::read.xlsx(params$coldata_xlsx)
expr3_all <- expr3
samples_to_exclude <- params$samples_to_exclude
if (is.null(samples_to_exclude) || length(samples_to_exclude) == 0) {
  expr3_filtered <- expr3
} else {
  sample_keys <- str_split(colnames(expr3), "_", simplify = TRUE)[, 1]
  expr3_filtered <- expr3[, !(sample_keys %in% samples_to_exclude)]
}

build_coldata <- function(expr_matrix, group_a, group_b, info) {
  coldata <- data.frame(samples = colnames(expr_matrix))
  coldata$condition <- sub("[0-9].*$", "", coldata$samples)
  coldata$condition3 <- str_split(coldata$samples, "_", simplify = TRUE)[, 1]

  coldata$condition2 <- case_when(
    select_group(group_a, coldata$condition) ~ group_a,
    select_group(group_b, coldata$condition) ~ group_b,
    TRUE ~ NA_character_
  )
  coldata <- coldata %>% filter(!is.na(condition2))
  coldata$condition2 <- factor(coldata$condition2, levels = c(group_a, group_b))
  expr_matrix <- expr_matrix[, coldata$samples]
  coldata <- left_join(coldata, info, by = c("condition3" = "Dreams"))

  list(expr = expr_matrix, coldata = coldata)
}

filtered_data <- build_coldata(expr3_filtered, group_a, group_b, info)
expr3 <- filtered_data$expr
coldata <- filtered_data$coldata

full_data <- build_coldata(expr3_all, group_a, group_b, info)
expr3_all <- full_data$expr
coldata_all <- full_data$coldata
```

```{r DESeq2}
cat("expr_xlsx: ", params$lfc_threshold, "\n")

design_formula <- params$design_formula
if (str_detect(design_formula, "\\bsex\\b")) {
  sex_levels <- if ("sex" %in% colnames(coldata)) {
    length(unique(na.omit(coldata$sex)))
  } else {
    0
  }
  if (sex_levels < 2) {
    design_formula <- str_replace_all(
      design_formula,
      "\\s*\\+\\s*sex\\b|\\bsex\\s*\\+\\s*",
      " "
    )
    design_formula <- str_replace_all(design_formula, "\\s+", " ")
    design_formula <- str_replace(design_formula, "\\+\\s*$", "")
    design_formula <- str_replace(design_formula, "~\\s*\\+", "~ ")
    if (str_trim(design_formula) %in% c("~", "")) {
      design_formula <- "~ condition2"
    }
  }
}

print(design_formula)

dds_all <- DESeqDataSetFromMatrix(
  countData = expr3_all,
  colData = coldata_all,
  design = as.formula(design_formula)
)

if (params$merge_replicates) {
  dds_all <- collapseReplicates(dds_all, dds_all$condition3, dds_all$samples)
}

dds_all <- dds_all[rowSums(counts(dds_all)) > 10, ]
dds_all$condition2 <- relevel(dds_all$condition2, ref = group_b)
dds_all <- estimateSizeFactors(dds_all)

dds <- DESeqDataSetFromMatrix(
  countData = expr3,
  colData = coldata,
  design = as.formula(design_formula)
)

if (params$merge_replicates) {
  dds <- collapseReplicates(dds, dds$condition3, dds$samples)
}

dds <- dds[rowSums(counts(dds)) > 10, ]
dds$condition2 <- relevel(dds$condition2, ref = group_b)
dds <- DESeq(dds)

coef_name <- paste0("condition2_", group_a, "_vs_", group_b)
res <- results(
  dds,
  contrast = c("condition2", group_a, group_b),
  lfcThreshold = params$lfc_threshold
)


res <- lfcShrink(
  dds,
  coef = coef_name,
  res = res,
  type = "apeglm"
)

rld_all <- vst(dds_all, blind = TRUE)
rld <- vst(dds, blind = TRUE)

finalDE_padj05 <- res %>%
  data.frame() %>%
  dplyr::filter(abs(log2FoldChange) > log2(2), padj < 0.05, baseMean > 50, lfcSE < 1) %>%
  rownames_to_column(var = "symbol")
finalDE <- res %>%
  data.frame() %>%
  dplyr::filter(baseMean > 50) %>%
  rownames_to_column(var = "symbol")
```

```{r entrezid}
gene.df <- bitr(
  finalDE_padj05$symbol,
  fromType = "SYMBOL",
  toType = c("SYMBOL", "ENTREZID"),
  OrgDb = org.Hs.eg.db,
  drop = FALSE
)

univ.gene.df <- bitr(
  finalDE$symbol,
  fromType = "SYMBOL",
  toType = c("SYMBOL", "ENTREZID"),
  OrgDb = org.Hs.eg.db,
  drop = FALSE
)

finalDE_symbol <- finalDE$log2FoldChange
names(finalDE_symbol) <- finalDE$symbol
finalDE_symbol <- finalDE_symbol[order(finalDE_symbol, decreasing = TRUE)]

finalDE_entrez <- left_join(finalDE, univ.gene.df, by = c("symbol" = "SYMBOL"))
finalDE_entrez <- finalDE_entrez[!(is.na(finalDE_entrez$ENTREZID)), ]
finalDE_entrez <- finalDE_entrez[order(finalDE_entrez$log2FoldChange, decreasing = TRUE), ]

gene.df_down <- finalDE_entrez %>%
  dplyr::filter(log2FoldChange < -log2(2), padj < 0.05) %>%
  pull(ENTREZID)
gene.df_up <- finalDE_entrez %>%
  dplyr::filter(log2FoldChange > log2(2), padj < 0.05) %>%
  pull(ENTREZID)
gene.df_all <- unique(c(gene.df_up, gene.df_down))

gsea_gene <- finalDE_entrez$log2FoldChange
names(gsea_gene) <- finalDE_entrez$ENTREZID
```

# QC {.tabset .tabset-fade}

```{r PCA}
data <- counts(dds, normalized = TRUE)

data <- data %>% t() %>% as.data.frame() %>% rownames_to_column(var = "ID")

ntop_all_genes_without <- nrow(assay(rld))
ntop_all_genes_with <- nrow(assay(rld_all))

pcaData_all_without <- plotPCA(
  rld,
  intgroup = c("samples", "condition2", "condition"),
  returnData = TRUE,
  ntop = ntop_all_genes_without
)
percentVar_all_without <- round(100 * attr(pcaData_all_without, "percentVar"))

pcaData_all_without <- pcaData_all_without %>%
  mutate(samples = str_split(samples, "_", simplify = TRUE) %>% .[, 1])

pcaData_all_with <- plotPCA(
  rld_all,
  intgroup = c("samples", "condition2", "condition"),
  returnData = TRUE,
  ntop = ntop_all_genes_with
)
percentVar_all_with <- round(100 * attr(pcaData_all_with, "percentVar"))

pcaData_all_with <- pcaData_all_with %>%
  mutate(samples = str_split(samples, "_", simplify = TRUE) %>% .[, 1])

pcaData_top_without <- plotPCA(
  rld,
  intgroup = c("samples", "condition2", "condition"),
  returnData = TRUE,
  ntop = 500
)
percentVar_top_without <- round(100 * attr(pcaData_top_without, "percentVar"))

pcaData_top_without <- pcaData_top_without %>%
  mutate(samples = str_split(samples, "_", simplify = TRUE) %>% .[, 1])

pcaData_top_with <- plotPCA(
  rld_all,
  intgroup = c("samples", "condition2", "condition"),
  returnData = TRUE,
  ntop = 500
)
percentVar_top_with <- round(100 * attr(pcaData_top_with, "percentVar"))

pcaData_top_with <- pcaData_top_with %>%
  mutate(samples = str_split(samples, "_", simplify = TRUE) %>% .[, 1])
```

## All genes {.tabset .tabset-fade}

### Sans WT3/DMD9

```{r PCA-all-genes-without}

ggplot(pcaData_all_without, aes(PC1, PC2, color = samples)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_shape_manual(values = 16:22) +
  scale_color_viridis_d(option = "turbo") +
  xlab(paste0("PC1: ", percentVar_all_without[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar_all_without[2], "% variance")) +
  coord_fixed(ratio = 4 / 3) +
  theme_bw()
```

### Avec WT3/DMD9

```{r PCA-all-genes-with}

ggplot(pcaData_all_with, aes(PC1, PC2, color = samples)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_shape_manual(values = 16:22) +
  scale_color_viridis_d(option = "turbo") +
  xlab(paste0("PC1: ", percentVar_all_with[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar_all_with[2], "% variance")) +
  coord_fixed(ratio = 4 / 3) +
  theme_bw()
```

### Heatmap

```{r pheatmap-all-genes}
mat_all <- assay(rld)
ann <- as.data.frame(colData(dds))[, c("condition", "condition2", "condition3"), drop = FALSE]

library(pheatmap)

rb_palette_all <- colorRampPalette(c("#2166AC", "white", "#B2182B"))(100)

pheatmap(
  mat_all,
  annotation_col = ann,
  show_rownames = FALSE,
  fontsize_col = 9,
  scale = "row",
  clustering_distance_rows = "correlation",
  clustering_distance_cols = "correlation",
  color = rb_palette_all,
  main = "All genes (VST, row-scaled)"
)
```

## Top 500 {.tabset .tabset-fade}

### Sans WT3/DMD9

```{r PCA-top-500-without}
ggplot(pcaData_top_without, aes(PC1, PC2, color = samples)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_shape_manual(values = 16:22) +
  scale_color_viridis_d(option = "turbo") +
  xlab(paste0("PC1: ", percentVar_top_without[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar_top_without[2], "% variance")) +
  coord_fixed(ratio = 4 / 3) +
  theme_bw()
```

### Avec WT3/DMD9

```{r PCA-top-500-with}
ggplot(pcaData_top_with, aes(PC1, PC2, color = samples)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_shape_manual(values = 16:22) +
  scale_color_viridis_d(option = "turbo") +
  xlab(paste0("PC1: ", percentVar_top_with[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar_top_with[2], "% variance")) +
  coord_fixed(ratio = 4 / 3) +
  theme_bw()
```

### Heatmap

```{r pheatmap-top-500}
mat <- assay(rld)

topVar <- head(order(rowVars(mat), decreasing = TRUE), 500)
mat_top <- mat[topVar, ]

rb_palette <- colorRampPalette(c("#2166AC", "white", "#B2182B"))(100)

pheatmap(
  mat_top,
  annotation_col = ann,
  show_rownames = FALSE,
  fontsize_col = 9,
  scale = "row",
  clustering_distance_rows = "correlation",
  clustering_distance_cols = "correlation",
  color = rb_palette,
  main = "Top variable genes (VST, row-scaled)"
)
```

# DEA {.tabset .tabset-fade}
## DEGs

```{r}
finalDE_VP <- finalDE
keyvals <- ifelse(
    finalDE_VP$log2FoldChange < -log2(2) & finalDE_VP$padj < .05 & finalDE_VP$baseMean > 20, 'royalblue',
      ifelse(finalDE_VP$log2FoldChange > log2(2) & finalDE_VP$padj <  .05 & finalDE_VP$baseMean > 20 , 'red',
        'grey'))
  keyvals[is.na(keyvals)] <- 'grey'
  names(keyvals)[keyvals == 'red'] <- 'Up-regulated'
  names(keyvals)[keyvals == 'grey'] <- 'Non-significant'
  names(keyvals)[keyvals == 'royalblue'] <- 'Down-regulated'
  
EnhancedVolcano(finalDE_VP, 
                lab = finalDE_VP$symbol, 
                title = "",
                subtitle = "",
                caption = paste0("Total = ", nrow(finalDE_VP), " variables, ",  "DEGs = ", nrow(finalDE_padj05), " corrected p-value (FDR) < 0.05 & ",  bquote("|FC| > 2 ")),
                x="log2FoldChange", 
                y= "padj",
                pCutoff = 5e-2,
                FCcutoff = log2(2),
                pointSize = 3.0,
                colCustom = keyvals,
                labSize = 5.0,
                labCol = 'black',
                labFace = 'bold',
                legendLabSize = 14,
                legendIconSize = 4.0,
                drawConnectors = TRUE,
                widthConnectors = .5,
                colConnectors = 'black')


data <- counts(dds, normalized=T)

data <- data %>% data.frame %>% rownames_to_column(var = "symbol")

finalDE_padj05 <- left_join(finalDE_padj05,data, by=c("symbol"))

finalDE_padj05 %>%  
  datatable_fun


finalDE_padj05 %>% 
  download_this(
    output_name = "DEGs_FC2_005_BM20",
    output_extension = ".xlsx",
    button_label = "Download table as xlsx",
    button_type = "success",
    has_icon = TRUE,
    icon = "fa fa-save"
  )



```

## All genes

```{r allgenes}

finalDE <- left_join(finalDE,data, by=c("symbol"))

finalDE %>%  
  datatable_fun

finalDE %>% 
  download_this(
    output_name = "All_genes",
    output_extension = ".xlsx",
    button_label = "Download table as xlsx",
    button_type = "success",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```


# Analyse d'enrichissement Gene Ontology

## Over-representation analysis {.tabset .tabset-fade}

### Cellular Component {.tabset .tabset-fade}

#### Up {.tabset .tabset-fade}

##### Table

```{r goccup}
gocc_up <- enrichGO(
  gene = gene.df_up,
  universe = univ.gene.df$ENTREZID,
  OrgDb = org.Hs.eg.db,
  ont = "CC",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE)

if (!is.null(gocc_up)) {
  test <- any(gocc_up@result$p.adjust < 0.1)

  if (test) {
    gocc_up <- setReadable(gocc_up, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    gocc_2 <- gocc_up %>% data.frame()
    gocc_2 %>% datatable_fun
  }
}
if (!is.null(gocc_up)) {
  if (test) {
    gocc_2 %>%
      download_this(
        output_name = "ORA CC up",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r dotplotgocc}
if (!is.null(gocc_up)) {
  if (test) {
    dotplot(gocc_up, showCategory = 15) + ggtitle("dotplot for ORA cc")
  }
}
```

##### Gene-Concept Network

```{r cnetplotgocc}
if (!is.null(gocc_up)) {
  if (test) {
    cnetplot(gocc_up, foldChange = gsea_gene)
  }
}
```

#### Down {.tabset .tabset-fade}

##### Table

```{r}
gocc_down <- enrichGO(
  gene = gene.df_down,
  universe = univ.gene.df$ENTREZID,
  OrgDb = org.Hs.eg.db,
  ont = "CC",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE
)

if (!is.null(gocc_down)) {
  test <- any(gocc_down@result$p.adjust < 0.1)

  if (test) {
    gocc_down <- setReadable(gocc_down, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    gocc_2 <- gocc_down %>% data.frame()
    gocc_2 %>% datatable_fun
  }
}
if (!is.null(gocc_down)) {
  if (test) {
    gocc_2 %>%
      download_this(
        output_name = "ORA CC down",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(gocc_down)) {
  if (test) {
    dotplot(gocc_down, showCategory = 15) + ggtitle("dotplot for ORA cc")
  }
}
```

##### Gene-Concept Network

```{r}
if (!is.null(gocc_down)) {
  if (test) {
    cnetplot(gocc_down, foldChange = gsea_gene)
  }
}
```

#### All {.tabset .tabset-fade}

##### Table

```{r}
gocc_all <- enrichGO(
  gene = gene.df_all,
  universe = univ.gene.df$ENTREZID,
  OrgDb = org.Hs.eg.db,
  ont = "CC",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE
)

if (!is.null(gocc_all)) {
  test <- any(gocc_all@result$p.adjust < 0.1)

  if (test) {
    gocc_all <- setReadable(gocc_all, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    gocc_2 <- gocc_all %>% data.frame()
    gocc_2 %>% datatable_fun
  }
}
if (!is.null(gocc_all)) {
  if (test) {
    gocc_2 %>%
      download_this(
        output_name = "ORA CC all",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(gocc_all)) {
  if (test) {
    dotplot(gocc_all, showCategory = 15) + ggtitle("dotplot for ORA cc")
  }
}
```

##### Gene-Concept Network

```{r}
if (!is.null(gocc_all)) {
  if (test) {
    cnetplot(gocc_all, foldChange = gsea_gene)
  }
}
```

### Molecular Function {.tabset .tabset-fade}

#### Up {.tabset .tabset-fade}

##### Table

```{r}
gomf_up <- enrichGO(
  gene = gene.df_up,
  universe = univ.gene.df$ENTREZID,
  OrgDb = org.Hs.eg.db,
  ont = "MF",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE)

if (!is.null(gomf_up)) {
  test <- any(gomf_up@result$p.adjust < 0.1)

  if (test) {
    gomf_up <- setReadable(gomf_up, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    gomf_2 <- gomf_up %>% as.data.frame()
    gomf_2 %>% datatable_fun
  }
}

if (!is.null(gomf_up)) {
  if (test) {
    gomf_2 %>%
      download_this(
        output_name = "ORA MF up",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(gomf_up)) {
  if (test) {
    dotplot(gomf_up, showCategory = 15) + ggtitle("dotplot for ORA MF")
  }
}
```

##### Gene-Concept Network

```{r}
if (!is.null(gomf_up)) {
  if (test) {
    cnetplot(gomf_up, foldChange = gsea_gene)
  }
}
```

#### Down {.tabset .tabset-fade}

##### Table

```{r}
gomf_down <- enrichGO(
  gene = gene.df_down,
  universe = univ.gene.df$ENTREZID,
  OrgDb = org.Hs.eg.db,
  ont = "MF",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE
)

if (!is.null(gomf_down)) {
  test <- any(gomf_down@result$p.adjust < 0.1)

  if (test) {
    gomf_down <- setReadable(gomf_down, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    gomf_2 <- gomf_down %>% as.data.frame()
    gomf_2 %>% datatable_fun
  }
}

if (!is.null(gomf_down)) {
  if (test) {
    gomf_2 %>%
      download_this(
        output_name = "ORA MF down",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(gomf_down)) {
  if (test) {
    dotplot(gomf_down, showCategory = 15) + ggtitle("dotplot for ORA MF")
  }
}
```

##### Gene-Concept Network

```{r}
if (!is.null(gomf_down)) {
  if (test) {
    cnetplot(gomf_down, foldChange = gsea_gene)
  }
}
```

#### All {.tabset .tabset-fade}

##### Table

```{r}
gomf_all <- enrichGO(
  gene = gene.df_all,
  universe = univ.gene.df$ENTREZID,
  OrgDb = org.Hs.eg.db,
  ont = "MF",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE
)

if (!is.null(gomf_all)) {
  test <- any(gomf_all@result$p.adjust < 0.1)

  if (test) {
    gomf_all <- setReadable(gomf_all, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    gomf_2 <- gomf_all %>% as.data.frame()
    gomf_2 %>% datatable_fun
  }
}

if (!is.null(gomf_all)) {
  if (test) {
    gomf_2 %>%
      download_this(
        output_name = "ORA MF all",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(gomf_all)) {
  if (test) {
    dotplot(gomf_all, showCategory = 15) + ggtitle("dotplot for ORA MF")
  }
}
```

##### Gene-Concept Network

```{r}
if (!is.null(gomf_all)) {
  if (test) {
    cnetplot(gomf_all, foldChange = gsea_gene)
  }
}
```

### Biolgical Process {.tabset .tabset-fade}

#### Up {.tabset .tabset-fade}

##### Table

```{r}
gobp_up <- enrichGO(
  gene = gene.df_up,
  universe = univ.gene.df$ENTREZID,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE
)

if (!is.null(gobp_up)) {
  test <- any(gobp_up@result$p.adjust < 0.1)

  if (test) {
    gobp_up <- setReadable(gobp_up, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    gobp_2 <- gobp_up %>% as.data.frame()
    gobp_2 %>% datatable_fun
  }
}

if (!is.null(gobp_up)) {
  if (test) {
    gobp_2 %>%
      download_this(
        output_name = "ORA BP up",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(gobp_up)) {
  if (test) {
    dotplot(gobp_up, showCategory = 15) + ggtitle("dotplot for ORA BP")
  }
}
```

##### Gene-Concept Network

```{r}
if (!is.null(gobp_up)) {
  if (test) {
    cnetplot(gobp_up, foldChange = gsea_gene)
  }
}
```

#### Down {.tabset .tabset-fade}

##### Table

```{r}
gobp_down <- enrichGO(
  gene = gene.df_down,
  universe = univ.gene.df$ENTREZID,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE
)

if (!is.null(gobp_down)) {
  test <- any(gobp_down@result$p.adjust < 0.1)

  if (test) {
    gobp_down <- setReadable(gobp_down, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    gobp_2 <- gobp_down %>% as.data.frame()
    gobp_2 %>% datatable_fun
  }
}

if (!is.null(gobp_down)) {
  if (test) {
    gobp_2 %>%
      download_this(
        output_name = "ORA BP down",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(gobp_down)) {
  if (test) {
    dotplot(gobp_down, showCategory = 15) + ggtitle("dotplot for ORA BP")
  }
}
```

##### Gene-Concept Network

```{r}
if (!is.null(gobp_down)) {
  if (test) {
    cnetplot(gobp_down, foldChange = gsea_gene)
  }
}
```

#### All {.tabset .tabset-fade}

##### Table

```{r}
gobp_all <- enrichGO(
  gene = gene.df_all,
  universe = univ.gene.df$ENTREZID,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE
)

if (!is.null(gobp_all)) {
  test <- any(gobp_all@result$p.adjust < 0.1)

  if (test) {
    gobp_all <- setReadable(gobp_all, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    gobp_2 <- gobp_all %>% as.data.frame()
    gobp_2 %>% datatable_fun
  }
}

if (!is.null(gobp_all)) {
  if (test) {
    gobp_2 %>%
      download_this(
        output_name = "ORA BP all",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(gobp_all)) {
  if (test) {
    dotplot(gobp_all, showCategory = 15) + ggtitle("dotplot for ORA BP")
  }
}
```

##### Gene-Concept Network

```{r}
if (!is.null(gobp_all)) {
  if (test) {
    cnetplot(gobp_all, foldChange = gsea_gene)
  }
}
```

```{r eval=FALSE, include=FALSE}
gc()
```

## GO Gene Set Enrichment Analysis {.tabset .tabset-fade}

### Cellular Component {.tabset .tabset-fade}

#### Table

```{r}
egocc <- gseGO(
  geneList = gsea_gene,
  OrgDb = org.Hs.eg.db,
  ont = "CC",
  keyType = "ENTREZID",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  verbose = FALSE
)

if (!is.null(egocc)) {
  test <- any(egocc@result$p.adjust < 0.1)

  if (test) {
    egocc <- setReadable(egocc, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    egocc_2 <- egocc %>% data.frame()
    egocc_2 %>% datatable_fun
  }
}
if (!is.null(egocc)) {
  if (test) {
    egocc_2 %>%
      download_this(
        output_name = "GSEA CC",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

#### Dotplot

```{r}
if (!is.null(egocc)) {
  if (test) {
    dotplot(egocc, showCategory = 15) + ggtitle("dotplot for GSEA cc")
  }
}
```

```{r eval=FALSE, include=FALSE}
gc()
```

### Molecular Function {.tabset .tabset-fade}

#### Table

```{r}
egomf <- gseGO(
  geneList = gsea_gene,
  OrgDb = org.Hs.eg.db,
  ont = "MF",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  verbose = FALSE
)

if (!is.null(egomf)) {
  test <- any(egomf@result$p.adjust < 0.1)

  if (test) {
    egomf <- setReadable(egomf, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    egomf_2 <- egomf %>% data.frame()
    egomf_2 %>% datatable_fun
  }
}
if (!is.null(egomf)) {
  if (test) {
    egomf_2 %>%
      download_this(
        output_name = "GSEA CC",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

#### Dotplot

```{r}
if (!is.null(egomf)) {
  if (test) {
    dotplot(egomf, showCategory = 15) + ggtitle("dotplot for GSEA MF")
  }
}
```

```{r eval=FALSE, include=FALSE}
gc()
```

### Biolgical Process {.tabset .tabset-fade}

#### Table

```{r}
egobp <- gseGO(
  geneList = gsea_gene,
  OrgDb = org.Hs.eg.db,
  ont = "BP",
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  verbose = FALSE
)

if (!is.null(egobp)) {
  test <- any(egobp@result$p.adjust < 0.1)

  if (test) {
    egobp <- setReadable(egobp, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    egobp_2 <- egobp %>% as.data.frame()
    egobp_2 %>% datatable_fun
  }
}

if (!is.null(egobp)) {
  if (test) {
    egobp_2 %>%
      download_this(
        output_name = "GSEA BP",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

#### Dotplot

```{r}
if (!is.null(egobp)) {
  if (test) {
    dotplot(egobp, showCategory = 15) + ggtitle("dotplot for GSEA BP")
  }
}
```

```{r eval=FALSE, include=FALSE}
gc()
```

# Pathway Enrichment

## KEGG {.tabset .tabset-fade}

### Pathway ORA {.tabset .tabset-fade}

#### Up {.tabset .tabset-fade}

##### Table

```{r}
kk_up <- enrichKEGG(
  gene = gene.df_up,
  organism = "hsa",
  keyType = "kegg",
  universe = univ.gene.df$ENTREZID,
  pvalueCutoff = 0.1,
  pAdjustMethod = "fdr"
  )

if (!is.null(kk_up)) {
  test <- any(kk_up@result$p.adjust < 0.1)

  if (test) {
    kk_up <- setReadable(kk_up, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    kk_2 <- kk_up %>% as.data.frame()

    kk_2 %>% datatable_fun
  }
}

if (!is.null(kk_up)) {
  if (test) {
    kk_2 %>%
      download_this(
        output_name = "ORA KEGG up",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(kk_up)) {
  if (test) {
    dotplot(kk_up, showCategory = 15) + ggtitle("dotplot for ORA KEGG")
  }
}
```

#### Down {.tabset .tabset-fade}

##### Table

```{r}
kk_down <- enrichKEGG(
  gene = gene.df_down,
  organism = "hsa",
  keyType = "kegg",
  universe = univ.gene.df$ENTREZID,
  pvalueCutoff = 0.1,
  pAdjustMethod = "fdr"
)

if (!is.null(kk_down)) {
  test <- any(kk_down@result$p.adjust < 0.1)

  if (test) {
    kk_down <- setReadable(kk_down, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    kk_2 <- kk_down %>% as.data.frame()
    kk_2 %>% datatable_fun
  }
}

if (!is.null(kk_down)) {
  if (test) {
    kk_2 %>%
      download_this(
        output_name = "ORA KEGG down",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(kk_down)) {
  if (test) {
    dotplot(kk_down, showCategory = 15) + ggtitle("dotplot for ORA KEGG")
  }
}
```

#### All {.tabset .tabset-fade}

##### Table

```{r}
kk_all <- enrichKEGG(
  gene = gene.df_all,
  organism = "hsa",
  keyType = "kegg",
  universe = univ.gene.df$ENTREZID,
  pvalueCutoff = 0.1,
  pAdjustMethod = "fdr"
)

if (!is.null(kk_all)) {
  test <- any(kk_all@result$p.adjust < 0.1)

  if (test) {
    kk_all <- setReadable(kk_all, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    kk_2 <- kk_all %>% as.data.frame()
    kk_2 %>% datatable_fun
  }
}

if (!is.null(kk_all)) {
  if (test) {
    kk_2 %>%
      download_this(
        output_name = "ORA KEGG all",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(kk_all)) {
  if (test) {
    dotplot(kk_all, showCategory = 15) + ggtitle("dotplot for ORA KEGG")
  }
}
```

### Pathway GSEA {.tabset .tabset-fade}

#### Table

```{r}
kkg <- gseKEGG(
  gene = gsea_gene,
  organism = "hsa",
  keyType = "kegg",
  pvalueCutoff = 0.1,
  pAdjustMethod = "fdr"
)

if (!is.null(kkg)) {
  test <- any(kkg@result$p.adjust < 0.1)

  if (test) {
    kkg <- setReadable(kkg, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    kkg_2 <- kkg %>% as.data.frame()
    kkg_2 %>% datatable_fun
  }
}

if (!is.null(kkg)) {
  if (test) {
    kkg_2 %>%
      download_this(
        output_name = "GSEA KEGG",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

#### Dotplot

```{r}
if (!is.null(kkg)) {
  if (test) {
    dotplot(kkg, showCategory = 15) + ggtitle("dotplot for GSEA KEGG")
  }
}
```

```{r eval=FALSE, include=FALSE}
gc()
```

## WikiPathways {.tabset .tabset-fade}

### Pathway ORA {.tabset .tabset-fade}

#### Up {.tabset .tabset-fade}

##### Table

```{r}
wpres_up <- enrichWP(
  gene.df_up,
  organism = "Homo sapiens",
  universe = univ.gene.df$ENTREZID,
  pvalueCutoff = 0.1,
  pAdjustMethod = "fdr"
)

if (!is.null(wpres_up)) {
  test <- any(wpres_up@result$p.adjust < 0.1)

  if (test) {
    wpres_up <- setReadable(wpres_up, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    wpres2 <- wpres_up %>% as.data.frame()
    wpres2 %>% datatable_fun
  }
}

if (!is.null(wpres_up)) {
  if (test) {
    wpres2 %>%
      download_this(
        output_name = "ORA WikiPathways up",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r}
if (!is.null(wpres_up)) {
  if (test) {
    dotplot(wpres_up, showCategory = 15) + ggtitle("dotplot for ORA WikiPathways")
  }
}
```

#### Down {.tabset .tabset-fade}

##### Table

```{r}
wpres_down <- enrichWP(
  gene.df_down,
  organism = "Homo sapiens",
  universe = univ.gene.df$ENTREZID,
  pvalueCutoff = 0.1,
  pAdjustMethod = "fdr"
)

if (!is.null(wpres_down)) {
  test <- any(wpres_down@result$p.adjust < 0.1)

  if (test) {
    wpres_down <- setReadable(wpres_down, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    wpres2 <- wpres_down %>% as.data.frame()
    wpres2 %>% datatable_fun
  }
}

if (!is.null(wpres_down)) {
  if (test) {
    wpres2 %>%
      download_this(
        output_name = "ORA WikiPathways down",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r, fig.width = 6, fig.height=7}
if (!is.null(wpres_down)) {
  if (test) {
    dotplot(wpres_down, showCategory = 15) + ggtitle("dotplot for GSEA WikiPathways")
  }
}
```

#### All {.tabset .tabset-fade}

##### Table

```{r}
wpres_all <- enrichWP(
  gene.df_all,
  organism = "Homo sapiens",
  universe = univ.gene.df$ENTREZID,
  pvalueCutoff = 0.1,
  pAdjustMethod = "fdr"
)

if (!is.null(wpres_all)) {
  test <- any(wpres_all@result$p.adjust < 0.1)

  if (test) {
    wpres_all <- setReadable(wpres_all, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    wpres2 <- wpres_all %>% as.data.frame()
    wpres2 %>% datatable_fun
  }
}

if (!is.null(wpres_all)) {
  if (test) {
    wpres2 %>%
      download_this(
        output_name = "ORA WikiPathways all",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r, fig.width = 6, fig.height=7}
if (!is.null(wpres_all)) {
  if (test) {
    dotplot(wpres_all, showCategory = 15) + ggtitle("dotplot for ORA WikiPathways")
  }
}
```

### Pathway GSEA {.tabset .tabset-fade}

#### Table

```{r}
wpresg <- gseWP(
  gsea_gene,
  organism = "Homo sapiens",
  pvalueCutoff = 0.1,
  pAdjustMethod = "fdr"
)

if (!is.null(wpresg)) {
  test <- any(wpresg@result$p.adjust < 0.1)

  if (test) {
    wpresg <- setReadable(wpresg, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    wpresg2 <- wpresg %>% as.data.frame()
    wpresg2 %>% datatable_fun
  }
}

if (!is.null(wpresg)) {
  if (test) {
    wpresg2 %>%
      download_this(
        output_name = "GSEA WikiPathways",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

#### Dotplot

```{r, fig.width = 6, fig.height=7}
if (!is.null(wpresg)) {
  if (test) {
    dotplot(wpresg, showCategory = 15) + ggtitle("dotplot for GSEA WikiPathways")
  }
}
```

```{r eval=FALSE, include=FALSE}
gc()
```

## Reactome {.tabset .tabset-fade}

### Pathway ORA {.tabset .tabset-fade}

#### Up {.tabset .tabset-fade}

##### Table

```{r}
reactome_up <- enrichPathway(
  gene = gene.df_up,
  universe = finalDE_entrez$ENTREZID,
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE
)

if (!is.null(reactome_up)) {
  test <- any(reactome_up@result$p.adjust < 0.1)

  if (test) {
    reactome_up <- setReadable(reactome_up, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    reactome_2 <- reactome_up %>% as.data.frame()
    reactome_2 %>% datatable_fun
  }
}

if (!is.null(reactome_up)) {
  if (test) {
    reactome_2 %>%
      download_this(
        output_name = "ORA reactome up",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r, fig.width = 6, fig.height=7}
if (!is.null(reactome_up)) {
  if (test) {
    dotplot(reactome_up, showCategory = 10) + ggtitle("dotplot for ORA reactome_up")
  }
}
```

#### Down {.tabset .tabset-fade}
##### Table

```{r}
reactome_down <- enrichPathway(
  gene = gene.df_down,
  universe = finalDE_entrez$ENTREZID,
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE
)

if (!is.null(reactome_down)) {
  test <- any(reactome_down@result$p.adjust < 0.1)

  if (test) {
    reactome_down <- setReadable(reactome_down, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    reactome_2 <- reactome_down %>% as.data.frame()
    reactome_2 %>% datatable_fun
  }
}

if (!is.null(reactome_down)) {
  if (test) {
    reactome_2 %>%
      download_this(
        output_name = "ORA reactome down",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r, fig.width = 6, fig.height=7}
if (!is.null(reactome_down)) {
  if (test) {
    dotplot(reactome_down, showCategory = 10) + ggtitle("dotplot for ORA reactome_down")
  }
}
```

#### All {.tabset .tabset-fade}
##### Table

```{r}
reactome_all <- enrichPathway(
  gene = gene.df_all,
  universe = finalDE_entrez$ENTREZID,
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  readable = TRUE
)

if (!is.null(reactome_all)) {
  test <- any(reactome_all@result$p.adjust < 0.1)

  if (test) {
    reactome_all <- setReadable(reactome_all, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    reactome_2 <- reactome_all %>% as.data.frame()
    reactome_2 %>% datatable_fun
  }
}

if (!is.null(reactome_all)) {
  if (test) {
    reactome_2 %>%
      download_this(
        output_name = "ORA reactome all",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

##### Dotplot

```{r, fig.width = 6, fig.height=7}
if (!is.null(reactome_all)) {
  if (test) {
    dotplot(reactome_all, showCategory = 10) + ggtitle("dotplot for ORA reactome_all")
  }
}
```

```{r eval=FALSE, include=FALSE}
gc()
```

### Pathway GSEA {.tabset .tabset-fade}

#### Table

```{r}
reactome_gsea <- gsePathway(
  gsea_gene,
  pAdjustMethod = "fdr",
  pvalueCutoff = 0.1,
  organism = "human"
)

if (!is.null(reactome_gsea)) {
  test <- any(reactome_gsea@result$p.adjust < 0.1)

  if (test) {
    reactome_gsea <- setReadable(reactome_gsea, OrgDb = org.Hs.eg.db, keyType = "ENTREZID")

    reactome_gsea_2 <- reactome_gsea %>% as.data.frame()
    reactome_gsea_2 %>% datatable_fun
  }
}

if (!is.null(reactome_gsea)) {
  if (test) {
    reactome_gsea_2 %>%
      download_this(
        output_name = "GSEA Reactome",
        output_extension = ".xlsx",
        button_label = "Download table as xlsx",
        button_type = "success",
        has_icon = TRUE,
        icon = "fa fa-save"
      )
  }
}
```

#### Dotplot

```{r, fig.width = 6, fig.height=7}
if (!is.null(reactome_gsea)) {
  if (test) {
    dotplot(reactome_gsea, showCategory = 10) + ggtitle("dotplot for GSEA Reactome")
  }
}
```
