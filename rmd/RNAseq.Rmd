---
title: "RNAseq DEG cross-comparison"
author: "Quentin"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
params:
  deg_root_dir: "results"
  run_tag: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r packages}
library(tidyverse)
library(openxlsx)
library(DT)
library(ComplexUpset)
library(ComplexHeatmap)
library(eulerr)
library(RColorBrewer)
```

```{r load-deg-files}
pattern <- if (nzchar(params$run_tag)) {
  paste0("^DEGs_.*_", params$run_tag, "\\\\.xlsx$")
} else {
  "^DEGs_.*\\\\.xlsx$"
}

deg_files <- list.files(
  params$deg_root_dir,
  pattern = pattern,
  full.names = TRUE,
  recursive = TRUE
)

if (length(deg_files) == 0) {
  stop("No DEG Excel files found in ", params$deg_root_dir, " with pattern: ", pattern)
}

comparison_names <- basename(deg_files) %>%
  str_remove("^DEGs_") %>%
  str_remove("\\\\.xlsx$") %>%
  str_remove(paste0("_", params$run_tag, "$"))

all_comp <- setNames(lapply(deg_files, openxlsx::read.xlsx), comparison_names)
all_comp <- all_comp[vapply(all_comp, nrow, integer(1)) > 0]

if (length(all_comp) < 2) {
  stop("At least two non-empty DEG files are required for comparisons.")
}

missing_cols <- names(all_comp)[!vapply(all_comp, function(df) {
  all(c("symbol", "log2FoldChange") %in% names(df))
}, logical(1))]

if (length(missing_cols) > 0) {
  stop("Missing required columns (symbol, log2FoldChange) in: ", paste(missing_cols, collapse = ", "))
}
```

```{r directed-genes}
all_comp_directed <- purrr::map(all_comp, \(df) {
  df %>%
    mutate(
      genes_directed = if_else(
        log2FoldChange > 0,
        paste0(symbol, "_up"),
        paste0(symbol, "_down")
      )
    )
})

gene_sets <- purrr::map(all_comp_directed, ~unique(.x$genes_directed))
```

# UpSet plot

```{r upset-plot, fig.height=9, fig.width=14}
upset_input <- UpSetR::fromList(gene_sets)

ComplexUpset::upset(
  upset_input,
  intersect = names(gene_sets),
  name = "DEGs",
  min_size = 5,
  width_ratio = 0.25
)
```

# Venn diagram

```{r venn-diagram, fig.height=8, fig.width=8}
if (length(gene_sets) >= 2 && length(gene_sets) <= 5) {
  cols <- setNames(brewer.pal(max(3, length(gene_sets)), "Set2")[seq_along(gene_sets)], names(gene_sets))
  fit <- venn(gene_sets)

  plot(
    fit,
    fills = list(fill = cols, alpha = 0.35),
    labels = list(font = 2, cex = 0.95),
    quantities = list(type = "counts", cex = 0.85),
    legend = FALSE
  )
} else {
  plot.new()
  text(0.5, 0.5, "Venn diagram available only when 2 to 5 DEG comparisons are loaded")
}
```

# Intersection query

```{r intersection-precompute}
# Full intersection catalog from all combinations
combo_tbl <- tibble(
  comparison = names(gene_sets),
  set = gene_sets
)

all_intersections <- map_dfr(2:length(gene_sets), function(k) {
  cmb <- combn(names(gene_sets), k, simplify = FALSE)
  map_dfr(cmb, function(sel) {
    genes <- reduce(gene_sets[sel], intersect)
    tibble(
      selected_comparisons = paste(sel, collapse = " âˆ© "),
      n_selected = k,
      n_genes = length(genes),
      genes = list(sort(genes))
    )
  })
})

all_intersections <- all_intersections %>%
  arrange(desc(n_genes), selected_comparisons)

query_output <- all_intersections %>%
  unnest_longer(genes, values_to = "gene")
```

```{r intersection-query-table}
DT::datatable(
  query_output,
  filter = "top",
  rownames = FALSE,
  options = list(pageLength = 25, scrollX = TRUE)
)
```

```{r helper-query-functions}
# Helper query functions for ad-hoc use in this report
get_intersection_genes <- function(selected, sets) {
  selected <- intersect(selected, names(sets))
  if (length(selected) < 2) {
    return(character(0))
  }
  sort(reduce(sets[selected], intersect))
}

get_exclusive_intersection_genes <- function(selected, sets) {
  selected <- intersect(selected, names(sets))
  if (length(selected) < 2) {
    return(character(0))
  }
  others <- setdiff(names(sets), selected)
  hits <- reduce(sets[selected], intersect)
  if (length(others) == 0) {
    return(sort(hits))
  }
  sort(setdiff(hits, reduce(sets[others], union)))
}

example_selected <- names(gene_sets)[seq_len(min(3, length(gene_sets)))]
example_genes <- get_intersection_genes(example_selected, gene_sets)
example_genes_exclusive <- get_exclusive_intersection_genes(example_selected, gene_sets)

tibble(
  query_type = c("inclusive", "exclusive"),
  selected = paste(example_selected, collapse = ", "),
  genes_found = c(length(example_genes), length(example_genes_exclusive))
) %>%
  DT::datatable(rownames = FALSE)
```
