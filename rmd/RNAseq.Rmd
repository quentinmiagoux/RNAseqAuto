---
title: "RNAseq DEG cross-comparison"
author: "Quentin"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
params:
  deg_root_dir: "results"
  run_tag: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r packages}
library(tidyverse)
library(openxlsx)
library(DT)
library(crosstalk)
library(ComplexUpset)
library(ComplexHeatmap)
library(eulerr)
library(RColorBrewer)
```

```{r load-deg-files}
pattern <- if (nzchar(params$run_tag)) {
  paste0("^DEGs_.*_", params$run_tag, "\\.xlsx$")
} else {
  "^DEGs_.*\\.xlsx$"
}

deg_candidates <- list.files(
  params$deg_root_dir,
  pattern = "\\.xlsx$",
  full.names = TRUE,
  recursive = TRUE
)

deg_files <- deg_candidates[str_detect(basename(deg_candidates), pattern)]

if (length(deg_files) == 0) {
  stop("No DEG Excel files found in ", params$deg_root_dir, " with pattern: ", pattern)
}

comparison_names <- basename(deg_files) %>%
  str_remove("^DEGs_") %>%
  str_remove("\\.xlsx$") %>%
  str_remove(paste0("_", params$run_tag, "$"))

all_comp <- setNames(lapply(deg_files, openxlsx::read.xlsx), comparison_names)
all_comp <- all_comp[vapply(all_comp, nrow, integer(1)) > 0]

if (length(all_comp) < 2) {
  stop("At least two non-empty DEG files are required for comparisons.")
}

missing_cols <- names(all_comp)[!vapply(all_comp, function(df) {
  all(c("symbol", "log2FoldChange") %in% names(df))
}, logical(1))]

if (length(missing_cols) > 0) {
  stop("Missing required columns (symbol, log2FoldChange) in: ", paste(missing_cols, collapse = ", "))
}
```

```{r directed-genes}
all_comp_directed <- purrr::map(all_comp, \(df) {
  df %>%
    mutate(
      genes_directed = if_else(
        log2FoldChange > 0,
        paste0(symbol, "_up"),
        paste0(symbol, "_down")
      )
    )
})

gene_sets <- purrr::map(all_comp_directed, ~unique(.x$genes_directed))

target_diseases <- c("DN", "DMD", "LMNA", "GSDII", "EDMD")
disease_regex <- paste0("(^|[^A-Za-z0-9])(", paste(target_diseases, collapse = "|"), ")([^A-Za-z0-9]|$)")

gene_sets_disease <- gene_sets[str_detect(names(gene_sets), regex(disease_regex, ignore_case = TRUE))]

if (length(gene_sets_disease) < 2) {
  stop(
    "At least two disease-specific comparisons are required among: ",
    paste(target_diseases, collapse = ", "),
    ". Found: ",
    paste(names(gene_sets_disease), collapse = ", ")
  )
}
```

# UpSet plot

```{r upset-plot, fig.height=9, fig.width=14}
upset_input <- UpSetR::fromList(gene_sets_disease)

ComplexUpset::upset(
  upset_input,
  intersect = names(gene_sets_disease),
  name = "DEGs",
  min_size = 5,
  width_ratio = 0.25
)
```

# Venn diagram

```{r venn-diagram, fig.height=8, fig.width=8}
n_sets <- length(gene_sets_disease)

if (n_sets >= 2 && n_sets <= 5) {
  cols <- brewer.pal(max(3, n_sets), "Set2")[seq_len(n_sets)]
  names(cols) <- names(gene_sets_disease)
  fit <- venn(gene_sets_disease)
  plot(fit,
       fills = list(fill = cols, alpha = 0.35),
       labels = list(font = 2, cex = 0.95),
       quantities = list(type = "counts", cex = 0.85),
       legend = FALSE)
} else {
  plot.new()
  text(0.5, 0.5, "Venn diagram available only when 2 to 5 DEG comparisons are loaded")
}
```

# Intersection query

```{r intersection-precompute}
cm <- make_comb_mat(gene_sets_disease)
comb_m <- as.matrix(cm)
comb_names <- comb_name(cm)

combo_label <- function(x) paste(x, collapse = " ∩ ")

exclusive_df <- do.call(rbind, lapply(seq_along(comb_names), function(i) {
  on_sets <- rownames(comb_m)[which(comb_m[, i] == 1)]

  g <- extract_comb(cm, comb_names[i])
  if (length(g) == 0) return(NULL)

  data.frame(
    intersection = combo_label(on_sets),
    gene = g,
    stringsAsFactors = FALSE
  )
}))

if (is.null(exclusive_df)) {
  exclusive_df <- data.frame(intersection = character(0), gene = character(0), stringsAsFactors = FALSE)
}

exclusive_df <- exclusive_df[grepl("∩", exclusive_df$intersection), , drop = FALSE]
exclusive_df <- exclusive_df[order(exclusive_df$intersection, exclusive_df$gene), ]
```

```{r intersection-query-table}
sd <- SharedData$new(exclusive_df)

filter_select(
  id = "intersection",
  label = "Choisir une intersection du Venn",
  sharedData = sd,
  group = ~intersection,
  multiple = FALSE
)

DT::datatable(
  sd,
  rownames = FALSE,
  options = list(
    pageLength = 50,
    dom = "ftip",
    columnDefs = list(
      list(visible = FALSE, targets = which(names(exclusive_df) == "intersection") - 1)
    )
  ),
  class = "compact stripe",
  filter = "none"
)
```

```{r helper-query-functions}
# Helper query functions for ad-hoc use in this report
get_intersection_genes <- function(selected, sets) {
  selected <- intersect(selected, names(sets))
  if (length(selected) < 2) {
    return(character(0))
  }
  sort(reduce(sets[selected], intersect))
}

get_exclusive_intersection_genes <- function(selected, sets) {
  selected <- intersect(selected, names(sets))
  if (length(selected) < 2) {
    return(character(0))
  }
  others <- setdiff(names(sets), selected)
  hits <- reduce(sets[selected], intersect)
  if (length(others) == 0) {
    return(sort(hits))
  }
  sort(setdiff(hits, reduce(sets[others], union)))
}

example_selected <- names(gene_sets_disease)[seq_len(min(3, length(gene_sets_disease)))]
example_genes <- get_intersection_genes(example_selected, gene_sets_disease)
example_genes_exclusive <- get_exclusive_intersection_genes(example_selected, gene_sets_disease)

tibble(
  query_type = c("inclusive", "exclusive"),
  selected = paste(example_selected, collapse = ", "),
  genes_found = c(length(example_genes), length(example_genes_exclusive))
) %>%
  DT::datatable(rownames = FALSE)
```
