---
title: "RNAseq DEG cross-comparison"
author: "Quentin"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
params:
  deg_root_dir: "results"
  run_tag: ""
  lfc: 2
  padj: 0.05
  lfc_threshold: 0
  bm: 50
  lfcse: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r packages}
library(tidyverse)
library(openxlsx)
library(DT)
library(downloadthis)
library(crosstalk)
library(htmltools)
library(ComplexUpset)
library(ComplexHeatmap)
library(eulerr)
library(RColorBrewer)
```

# Parameters used

```{r analysis-parameters}
analysis_params <- tibble::tibble(
  parameter = c("run_tag", "fold_change (lfc)", "padj", "lfc_threshold", "baseMean (bm)", "lfcSE"),
  value = c(
    params$run_tag,
    as.character(params$lfc),
    as.character(params$padj),
    as.character(params$lfc_threshold),
    as.character(params$bm),
    as.character(params$lfcse)
  )
)

DT::datatable(
  analysis_params,
  rownames = FALSE,
  options = list(dom = "t", paging = FALSE),
  class = "compact stripe"
)
```


```{r load-deg-files}
pattern <- if (nzchar(params$run_tag)) {
  paste0("^DEGs_.*_", params$run_tag, "\\.xlsx$")
} else {
  "^DEGs_.*\\.xlsx$"
}

deg_candidates <- list.files(
  params$deg_root_dir,
  pattern = "\\.xlsx$",
  full.names = TRUE,
  recursive = TRUE
)

deg_files <- deg_candidates[str_detect(basename(deg_candidates), pattern)]

if (length(deg_files) == 0) {
  stop("No DEG Excel files found in ", params$deg_root_dir, " with pattern: ", pattern)
}

comparison_names <- basename(deg_files) %>%
  str_remove("^DEGs_") %>%
  str_remove("\\.xlsx$") %>%
  str_remove(paste0("_", params$run_tag, "$"))

all_comp <- setNames(lapply(deg_files, openxlsx::read.xlsx), comparison_names)
all_comp <- all_comp[vapply(all_comp, nrow, integer(1)) > 0]

if (length(all_comp) < 2) {
  stop("At least two non-empty DEG files are required for comparisons.")
}

missing_cols <- names(all_comp)[!vapply(all_comp, function(df) {
  all(c("symbol", "log2FoldChange") %in% names(df))
}, logical(1))]

if (length(missing_cols) > 0) {
  stop("Missing required columns (symbol, log2FoldChange) in: ", paste(missing_cols, collapse = ", "))
}
```

```{r directed-genes}
all_comp_directed <- purrr::map(all_comp, \(df) {
  df %>%
    mutate(
      genes_directed = if_else(
        log2FoldChange > 0,
        paste0(symbol, "_up"),
        paste0(symbol, "_down")
      )
    )
})

gene_sets <- purrr::map(all_comp_directed, ~unique(.x$genes_directed))

target_diseases <- c("DN", "DMD", "LMNA", "GSDII", "DNM2")
disease_regex <- paste0("(^|[^A-Za-z0-9])(", paste(target_diseases, collapse = "|"), ")([^A-Za-z0-9]|$)")

gene_sets_disease <- gene_sets[str_detect(names(gene_sets), regex(disease_regex, ignore_case = TRUE))]

if (length(gene_sets_disease) < 2) {
  stop(
    "At least two disease-specific comparisons are required among: ",
    paste(target_diseases, collapse = ", "),
    ". Found: ",
    paste(names(gene_sets_disease), collapse = ", ")
  )
}
```

# UpSet plot

```{r upset-plot, fig.height=9, fig.width=14}
upset_input <- UpSetR::fromList(gene_sets_disease)

ComplexUpset::upset(
  upset_input,
  intersect = names(gene_sets_disease),
  name = "DEGs",
  min_size = 5,
  width_ratio = 0.25
)
```

# Venn diagram

```{r venn-diagram, fig.height=9, fig.width=9}
  cols <- setNames(brewer.pal(max(3, length(gene_sets_disease)), "Set2")[seq_along(gene_sets_disease)], names(gene_sets_disease))
  fit <- venn(gene_sets_disease)

  plot(
    fit,
    fills = list(fill = cols, alpha = 0.35),
    labels = list(font = 2, cex = 0.95),
    quantities = list(type = "counts", cex = 0.85),
    legend = FALSE
  )

```

# Intersection query

```{r intersection-precompute}
cm <- make_comb_mat(gene_sets_disease)
comb_m <- as.matrix(cm)
comb_names <- comb_name(cm)

combo_label <- function(x) paste(x, collapse = " Ã¢Ë†Â© ")

exclusive_df <- do.call(rbind, lapply(seq_along(comb_names), function(i) {
  on_sets <- rownames(comb_m)[which(comb_m[, i] == 1)]

  g <- extract_comb(cm, comb_names[i])
  if (length(g) == 0) return(NULL)

  data.frame(
    intersection = combo_label(on_sets),
    gene = g,
    stringsAsFactors = FALSE
  )
}))

if (is.null(exclusive_df)) {
  exclusive_df <- data.frame(intersection = character(0), gene = character(0), stringsAsFactors = FALSE)
}

exclusive_df <- exclusive_df[grepl("Ã¢Ë†Â©", exclusive_df$intersection), , drop = FALSE]
exclusive_df <- exclusive_df[order(exclusive_df$intersection, exclusive_df$gene), ]
```

```{r intersection-query-table}
sd <- SharedData$new(exclusive_df)

filter_select(
  id = "intersection",
  label = "Choisir une intersection du Venn",
  sharedData = sd,
  group = ~intersection,
  multiple = FALSE
)

DT::datatable(
  sd,
  rownames = FALSE,
  options = list(
    pageLength = 50,
    dom = "ftip",
    columnDefs = list(
      list(visible = FALSE, targets = which(names(exclusive_df) == "intersection") - 1)
    )
  ),
  class = "compact stripe",
  filter = "none"
)
```

# Disease logFC summary table

```{r disease-summary-table-build}
canonicalize_disease <- function(x) {
  normalized <- x %>%
    str_to_upper() %>%
    str_replace_all("[^A-Z0-9]", "")

  dplyr::case_when(
    normalized == "DN" ~ "DN",
    normalized == "DMD" ~ "DMD",
    normalized == "LMNA" ~ "LMNA",
    normalized == "GSDII" ~ "GSDII",
    normalized %in% c("DNM2", "DNMII") ~ "DNM2",
    TRUE ~ NA_character_
  )
}

target_diseases <- c("DMD", "LMNA", "DN", "DNM2", "GSDII")

disease_matches <- purrr::imap_dfr(all_comp, function(df, comparison_name) {
  tokens <- str_split(comparison_name, "[^A-Za-z0-9]+", simplify = FALSE)[[1]]
  disease <- canonicalize_disease(tokens)
  disease <- disease[!is.na(disease)]

  if (length(disease) == 0) {
    return(tibble())
  }

  tibble(
    comparison_name = comparison_name,
    disease = disease[[1]]
  )
}) %>%
  filter(disease %in% target_diseases) %>%
  distinct()

if (nrow(disease_matches) == 0) {
  stop("No disease-specific DEG files found for: ", paste(target_diseases, collapse = ", "))
}

disease_map <- disease_matches %>%
  group_by(disease) %>%
  summarise(
    comparison_name = first(comparison_name),
    n_matches = n(),
    .groups = "drop"
  )

if (any(disease_map$n_matches > 1)) {
  warning(
    "Multiple DEG files matched for some diseases. Using the first match for: ",
    paste(disease_map$disease[disease_map$n_matches > 1], collapse = ", ")
  )
}

missing_diseases <- setdiff(target_diseases, disease_map$disease)
if (length(missing_diseases) > 0) {
  warning("Missing disease-specific DEG files for: ", paste(missing_diseases, collapse = ", "))
}

pvalue_threshold <- if (!is.null(params$padj)) params$padj else 0.05
fc_threshold <- if (!is.null(params$lfc)) params$lfc else if (!is.null(params$lfc_threshold)) params$lfc_threshold else 2

build_disease_table <- function(df, disease) {
  p_col <- if ("padj" %in% names(df)) {
    "padj"
  } else if ("pvalue" %in% names(df)) {
    "pvalue"
  } else {
    stop("Missing p-value column (padj or pvalue) for disease: ", disease)
  }

  df %>%
    transmute(
      gene = symbol,
      !!paste0("logFC_", disease) := round(log2FoldChange, 3),
      !!paste0("pass_", disease) := !!sym(p_col) < pvalue_threshold &
        abs(log2FoldChange) >= log2(fc_threshold)
    ) %>%
    distinct(gene, .keep_all = TRUE)
}

disease_tables <- purrr::map2(
  disease_map$comparison_name,
  disease_map$disease,
  ~build_disease_table(all_comp[[.x]], .y)
)

gene_disease_summary <- reduce(disease_tables, full_join, by = "gene") %>%
  mutate(
    across(starts_with("pass_"), ~replace_na(.x, FALSE)),
    Count = rowSums(across(starts_with("pass_"), as.integer))
  ) %>%
  arrange(desc(Count), gene)

for (d in target_diseases) {
  logfc_col <- paste0("logFC_", d)
  pass_col <- paste0("pass_", d)

  if (!logfc_col %in% names(gene_disease_summary)) {
    gene_disease_summary[[logfc_col]] <- NA_real_
  }
  if (!pass_col %in% names(gene_disease_summary)) {
    gene_disease_summary[[pass_col]] <- FALSE
  }
}

gene_disease_summary <- gene_disease_summary %>%
  select(
    gene,
    all_of(paste0("logFC_", target_diseases)),
    Count
  )

summary_xlsx <- file.path(getwd(), "gene_disease_logFC_summary.xlsx")
openxlsx::write.xlsx(gene_disease_summary, summary_xlsx, overwrite = TRUE)
```

```{r disease-summary-table-display}
DT::datatable(
  gene_disease_summary,
  rownames = FALSE,
  extensions = "Buttons",
  options = list(
    pageLength = 25,
    scrollX = TRUE,
    dom = "Bfrtip",
    buttons = list(
      list(
        extend = "excelHtml5",
        text = "Download full table (Excel)",
        filename = "gene_disease_logFC_summary",
        exportOptions = list(modifier = list(page = "all"))
      )
    )
  ),
  class = "compact stripe"
)

gene_disease_summary %>%
  download_this(
    output_name = "gene_disease_logFC_summary",
    output_extension = ".xlsx",
    button_label = "Download table as xlsx",
    button_type = "success",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```
